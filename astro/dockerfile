FROM archlinux:latest

# Install base system and dev dependencies
RUN pacman -Syu --noconfirm && \
    pacman-key --init && \
    pacman-key --populate archlinux && \
    pacman -S --noconfirm \
      git base-devel neovim ripgrep fd lua unzip npm \
      python-pip xclip rust go curl sudo tmux wget \
      python-pynvim nodejs npm tzdata

# Set timezone to Pacific Time
RUN ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
RUN echo "America/Los_Angeles" > /etc/timezone

# Create non-root user
RUN useradd -m developer && \
    echo "developer ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

# Switch to developer user for all configuration
USER developer
WORKDIR /home/developer

# Install OpenCode
RUN curl -fsSL https://opencode.ai/install | bash

# Install AstroNvim using the template
RUN git clone --depth 1 https://github.com/AstroNvim/template ~/.config/nvim
RUN rm -rf ~/.config/nvim/.git

# Create user configuration directory
RUN mkdir -p ~/.config/nvim/lua/plugins

# Create melange plugin configuration
RUN echo "return {" > ~/.config/nvim/lua/plugins/melange.lua
RUN echo "  \"savq/melange-nvim\"," >> ~/.config/nvim/lua/plugins/melange.lua
RUN echo "  lazy = false," >> ~/.config/nvim/lua/plugins/melange.lua
RUN echo "  priority = 1000," >> ~/.config/nvim/lua/plugins/melange.lua
RUN echo "  config = function()" >> ~/.config/nvim/lua/plugins/melange.lua
RUN echo "    vim.cmd.colorscheme(\"melange\")" >> ~/.config/nvim/lua/plugins/melange.lua
RUN echo "  end," >> ~/.config/nvim/lua/plugins/melange.lua
RUN echo "}" >> ~/.config/nvim/lua/plugins/melange.lua

# Configure AstroUI to use melange as default colorscheme
RUN sed -i 's/colorscheme = "astrodark"/colorscheme = "melange"/' ~/.config/nvim/lua/plugins/astroui.lua

# Ensure melange is set in the polish.lua for final override
RUN echo 'vim.cmd.colorscheme("melange")' >> ~/.config/nvim/lua/polish.lua

# Sync Neovim plugins after all configuration
RUN nvim --headless "+Lazy! sync" +qa

# Configure tmux
RUN cat <<EOF > ~/.tmux.conf
# Change prefix from Ctrl-B to `
unbind C-b
set -g prefix \`
bind \` send-prefix

# Enable true color
set -as terminal-features ',xterm*:RGB'
set -g default-terminal "screen-256color"


# Status bar colors (Melange-inspired)
set -g status-bg '#2d2721'
set -g status-fg '#726450'
set -g status-left-length 40
set -g status-right-length 80

# Window status colors
set -g window-status-current-style 'bg=#2d2721,fg=#A3A9CE,bold'
set -g window-status-style 'bg=#2d2721,fg=#c7b195'
set -g window-status-separator ' '

# Pane border colors
set -g pane-border-style 'fg=#4f4135'
set -g pane-active-border-style 'fg=#A3A9CE'

# Message colors
set -g message-style 'bg=#c7b195,fg=#2d2721,bold'
set -g message-command-style 'bg=#f4135,fg=#c7b195'

# Mode colors (copy mode, etc.)
set -g mode-style 'bg=#c7b195,fg=#2d2721'

# Status bar content
set -g status-left '#[bg=#4f4135,fg=#c7b195,bold] #S #[default]'
set -g status-right '#[bg=#4f4135,fg=#c7b195] %Y-%m-%d #[bg=#A3A9CE,fg=#2d2721,bold] %H:%M '

# Window status format
set -g window-status-format ' #I:#W '
set -g window-status-current-format ' #[#A3A9CE]‚óè #[default]#I:#W '

# Clock color
set -g clock-mode-colour '#A3A9CE'

# Other useful settings
#set -g mouse on
set -g base-index 1
set -g pane-base-index 1
set -g renumber-windows on
set -g set-titles on
set -g set-titles-string '#T'
set -g status-position top

# Key bindings
bind r source-file ~/.tmux.conf \; display-message "Config reloaded!"
bind | split-window -h
bind - split-window -v
EOF

# Add local binaries to PATH
ENV PATH="/home/developer/.local/bin:${PATH}"

# Default command
CMD [ "bash" ]
